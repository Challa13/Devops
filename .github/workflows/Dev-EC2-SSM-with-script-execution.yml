name: Dev EC2 SSM Execution

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: "Specific EC2 Instance ID (optional)"
        required: false
      tag_key:
        description: "Tag key (default: Environment)"
        required: false
        default: Environment
      tag_value:
        description: "Tag value (default: dev)"
        required: false
        default: dev
      dry_run:
        description: "Dry run (true/false)"
        required: false
        default: "true"

  schedule:
    - cron: "0 2 * * *"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-1

jobs:
  ssm-run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # âœ… OIDC Authentication
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::034362042633:role/github-role11
          aws-region: ${{ env.AWS_REGION }}

      # âœ… Dev Guardrail
      - name: Validate Dev Target
        run: |
          TAG_VALUE="${{ github.event.inputs.tag_value || 'dev' }}"
          if [[ "$TAG_VALUE" != "dev" ]]; then
            echo "âŒ Only dev environment is allowed."
            exit 1
          fi
          echo "âœ… Dev guardrail passed"

      # âœ… Resolve Instances
      - name: Get EC2 Instance IDs
        id: get_instances
        run: |
          if [[ -n "${{ github.event.inputs.instance_id }}" ]]; then
            INSTANCE_IDS="${{ github.event.inputs.instance_id }}"
          else
            INSTANCE_IDS=$(aws ec2 describe-instances \
              --filters "Name=tag:${{ github.event.inputs.tag_key || 'Environment' }},Values=${{ github.event.inputs.tag_value || 'dev' }}" \
                        "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].InstanceId" \
              --output text)
          fi

          if [[ -z "$INSTANCE_IDS" ]]; then
            echo "âŒ No running dev instances found"
            exit 1
          fi

          echo "instance_ids=$INSTANCE_IDS" >> $GITHUB_OUTPUT

      # âœ… Dry Run
      - name: Dry Run
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸš¦ DRY RUN ENABLED"
          echo "Would execute scripts/server_info.sh on: ${{ steps.get_instances.outputs.instance_ids }}"
          exit 0

      # âœ… Prepare Script for SSM
      - name: Prepare Script for SSM
        id: prepare_script
        run: |
          SCRIPT_JSON=$(jq -Rs '{commands: split("\n")}' scripts/server_info.sh)
          echo "$SCRIPT_JSON" > ssm-commands.json
          echo "Prepared SSM command payload"

      # âœ… Send Command
      - name: Execute server_info.sh via SSM
        id: send_command
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids ${{ steps.get_instances.outputs.instance_ids }} \
            --parameters file://ssm-commands.json \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      # âœ… Wait for completion (first instance)
      - name: Wait for command
        run: |
          FIRST_INSTANCE=$(echo ${{ steps.get_instances.outputs.instance_ids }} | awk '{print $1}')
          aws ssm wait command-executed \
            --command-id ${{ steps.send_command.outputs.command_id }} \
            --instance-id $FIRST_INSTANCE

      # âœ… Fetch Output as TXT
      - name: Fetch SSM Output as TXT
        run: |
          mkdir -p ssm-logs
          for INSTANCE in ${{ steps.get_instances.outputs.instance_ids }}
          do
            aws ssm get-command-invocation \
              --command-id ${{ steps.send_command.outputs.command_id }} \
              --instance-id $INSTANCE \
              --query "StandardOutputContent" \
              --output text > ssm-logs/server_info_$INSTANCE.txt
          done

      # âœ… Upload Logs
      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: ssm-logs
          path: ssm-logs/*.txt
