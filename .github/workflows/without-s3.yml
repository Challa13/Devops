name: Dev EC2 SSM Execution

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: "Specific EC2 Instance ID (optional)"
        required: false
      tag_key:
        description: "Tag key (default: Environment)"
        required: false
        default: Environment
      tag_value:
        description: "Tag value (default: dev)"
        required: false
        default: dev
      dry_run:
        description: "Dry run (true/false)"
        required: false
        default: "true"
      script_args:
        description: "Script arguments"
        required: false
        default: ""

  schedule:
    - cron: "0 2 * * *"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-1

jobs:
  ssm-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::034362042633:role/roleforssm
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate Dev Target
        run: |
          TAG_VALUE="${{ github.event.inputs.tag_value || 'dev' }}"
          if [[ "$TAG_VALUE" != "dev" ]]; then
            echo "âŒ Only dev environment is allowed."
            exit 1
          fi

      - name: Get EC2 Instance IDs
        id: get_instances
        run: |
          if [[ -n "${{ github.event.inputs.instance_id }}" ]]; then
            INSTANCE_IDS="${{ github.event.inputs.instance_id }}"
          else
            INSTANCE_IDS=$(aws ec2 describe-instances \
              --filters "Name=tag:${{ github.event.inputs.tag_key || 'Environment' }},Values=${{ github.event.inputs.tag_value || 'dev' }}" \
                        "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].InstanceId" \
              --output text)
          fi

          if [[ -z "$INSTANCE_IDS" ]]; then
            echo "âŒ No running dev instances found"
            exit 1
          fi

          echo "Found instances: $INSTANCE_IDS"
          echo "instance_ids=$INSTANCE_IDS" >> $GITHUB_OUTPUT

      - name: Dry Run
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸš¦ DRY RUN ENABLED"
          echo "Would execute on: ${{ steps.get_instances.outputs.instance_ids }}"
          exit 0

      - name: Prepare Script for SSM
        run: |
          SCRIPT_ARGS="${{ github.event.inputs.script_args || '' }}"

          {
            echo "cat > /tmp/update_check.sh << 'EOF'"
            cat scripts/update_check.sh
            echo "EOF"
            echo "chmod +x /tmp/update_check.sh"
            echo "/tmp/update_check.sh ${SCRIPT_ARGS}"
          } > run_update.sh

          jq -Rs '{commands: split("\n") | map(select(length > 0))}' run_update.sh > ssm-commands.json

      - name: Execute via SSM
        id: send_command
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids ${{ steps.get_instances.outputs.instance_ids }} \
            --parameters file://ssm-commands.json \
            --cloud-watch-output-config CloudWatchOutputEnabled=true \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Wait for command completion (All Instances)
        id: wait_command
        run: |
          SUCCESS_COUNT=0
          FAILURE_COUNT=0
          FAILED_INSTANCES=""

          for INSTANCE in ${{ steps.get_instances.outputs.instance_ids }}
          do
            echo "Checking status for $INSTANCE"
            STATUS="InProgress"

            while [[ "$STATUS" == "InProgress" || "$STATUS" == "Pending" ]]; do
              sleep 5
              STATUS=$(aws ssm get-command-invocation \
                --command-id ${{ steps.send_command.outputs.command_id }} \
                --instance-id $INSTANCE \
                --query "Status" \
                --output text)
              echo "$INSTANCE â†’ $STATUS"
            done

            if [[ "$STATUS" == "Success" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
            else
              FAILURE_COUNT=$((FAILURE_COUNT+1))
              FAILED_INSTANCES="$FAILED_INSTANCES $INSTANCE"
            fi
          done

          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
          echo "failed_instances=$FAILED_INSTANCES" >> $GITHUB_OUTPUT

          if [[ "$FAILURE_COUNT" -gt 0 ]]; then
            echo "âŒ One or more instances failed."
            exit 1
          fi

      - name: Fetch Output for GitHub Artifact
        if: always()
        run: |
          mkdir -p ssm-logs

          for INSTANCE in ${{ steps.get_instances.outputs.instance_ids }}
          do
            aws ssm get-command-invocation \
              --command-id ${{ steps.send_command.outputs.command_id }} \
              --instance-id $INSTANCE \
              --query "StandardOutputContent" \
              --output text > ssm-logs/update_report_$INSTANCE.txt || true

            aws ssm get-command-invocation \
              --command-id ${{ steps.send_command.outputs.command_id }} \
              --instance-id $INSTANCE \
              --query "StandardErrorContent" \
              --output text > ssm-logs/update_report_$INSTANCE.err || true
          done

      - name: Upload logs to GitHub Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ssm-logs-${{ github.run_id }}
          path: ssm-logs/*
          retention-days: 7

      - name: Execution Summary
        if: always()
        run: |
          echo "## ðŸš€ SSM Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** $AWS_REGION" >> $GITHUB_STEP_SUMMARY
          echo "**Command ID:** ${{ steps.send_command.outputs.command_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Instances:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.get_instances.outputs.instance_ids }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Successful:** ${{ steps.wait_command.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed:** ${{ steps.wait_command.outputs.failure_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.wait_command.outputs.failure_count }}" -gt 0 ]]; then
            echo "âŒ Failed Instances:" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.wait_command.outputs.failed_instances }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All instances executed successfully." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Logs stored in GitHub Artifacts (retention: 7 days)" >> $GITHUB_STEP_SUMMARY
