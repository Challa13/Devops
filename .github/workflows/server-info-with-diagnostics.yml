name: Run Server Info on EC2 with Diagnostics

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 Instance ID'
        required: false
        default: 'i-01edf5a092db9d3e3'
      install_ssm_agent:
        description: 'Auto-install SSM agent if missing'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-west-1
  AWS_DEFAULT_REGION: us-west-1
  S3_BUCKET: dev-ssm-server-logs
  S3_PREFIX: server-info
  INSTANCE_ID: i-01edf5a092db9d3e3
  ROLE_ARN: arn:aws:iam::034362042633:role/github-role11

jobs:
  diagnose-and-run:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Validate Script Exists
        run: |
          if [ ! -f scripts/server_info.sh ]; then
            echo "‚ùå ERROR: scripts/server_info.sh not found!"
            exit 1
          fi
          echo "‚úì Script found"

      - name: Check Instance State
        id: check-instance
        run: |
          INSTANCE_ID=${{ github.event.inputs.instance_id || env.INSTANCE_ID }}
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          
          echo "üîç Checking instance: $INSTANCE_ID"
          
          INSTANCE_INFO=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'Reservations[0].Instances[0]' \
            --output json)
          
          INSTANCE_STATE=$(echo "$INSTANCE_INFO" | jq -r '.State.Name')
          INSTANCE_ROLE=$(echo "$INSTANCE_INFO" | jq -r '.IamInstanceProfile.Arn // "None"')
          
          echo "Instance State: $INSTANCE_STATE"
          echo "IAM Role: $INSTANCE_ROLE"
          
          if [[ "$INSTANCE_STATE" != "running" ]]; then
            echo "‚ö†Ô∏è  Starting instance..."
            aws ec2 start-instances --instance-ids "$INSTANCE_ID" --region ${{ env.AWS_REGION }}
            aws ec2 wait instance-running --instance-ids "$INSTANCE_ID" --region ${{ env.AWS_REGION }}
            echo "‚úì Instance is running"
          fi
          
          if [[ "$INSTANCE_ROLE" == "None" ]]; then
            echo "‚ùå ERROR: Instance has no IAM role attached!"
            echo "Please attach an IAM role with SSM permissions to this instance"
            exit 1
          fi
          
          echo "instance_state=$INSTANCE_STATE" >> $GITHUB_OUTPUT
          echo "instance_role=$INSTANCE_ROLE" >> $GITHUB_OUTPUT

      - name: Diagnose SSM Agent Status
        id: diagnose
        run: |
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          
          echo "üîß Running Diagnostics..."
          echo ""
          
          # Check if instance appears in SSM
          echo "Step 1: Checking if instance is visible to SSM..."
          SSM_INSTANCE=$(aws ssm describe-instance-information \
            --instance-information-filter-list "key=InstanceIds,valueSet=$INSTANCE_ID" \
            --region ${{ env.AWS_REGION }} \
            --query "InstanceInformationList[0]" \
            --output json)
          
          PING_STATUS=$(echo "$SSM_INSTANCE" | jq -r '.PingStatus // "MISSING"')
          AGENT_VERSION=$(echo "$SSM_INSTANCE" | jq -r '.AgentVersion // "NONE"')
          
          echo "  Ping Status: $PING_STATUS"
          echo "  Agent Version: $AGENT_VERSION"
          echo ""
          
          if [[ "$PING_STATUS" == "MISSING" ]]; then
            echo "‚ùå Instance not visible to SSM (agent may not be installed or configured)"
            echo ""
            echo "Step 2: Instance details via EC2:"
            aws ec2 describe-instances \
              --instance-ids "$INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query 'Reservations[0].Instances[0].[InstanceId,InstanceType,State.Name,IamInstanceProfile.Arn,Platform]' \
              --output table
            echo ""
            echo "Diagnostic Summary:"
            echo "  - SSM Agent Status: NOT REPORTING"
            echo "  - Next Step: Need to install/fix SSM agent"
            echo ""
            echo "diagnose_status=agent_missing" >> $GITHUB_OUTPUT
          else
            echo "‚úì Instance is visible to SSM"
            echo "diagnose_status=agent_ok" >> $GITHUB_OUTPUT
          fi

      - name: Create SSM Agent Install Script
        if: steps.diagnose.outputs.diagnose_status == 'agent_missing' && github.event.inputs.install_ssm_agent == 'true'
        run: |
          cat > /tmp/install_ssm_agent.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e
          echo "=== SSM Agent Installation ==="
          echo "Instance: $(hostname)"
          echo "OS: $(uname -s)"
          echo ""
          
          # Detect OS
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            OS=$ID
          else
            OS="unknown"
          fi
          
          echo "Detected OS: $OS"
          
          # Install based on OS
          if [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
            echo "Installing for Ubuntu/Debian..."
            apt-get update
            apt-get install -y amazon-ssm-agent
            systemctl start amazon-ssm-agent
            systemctl enable amazon-ssm-agent
            echo "SSM Agent status:"
            systemctl status amazon-ssm-agent
          elif [[ "$OS" == "amzn" || "$OS" == "rhel" || "$OS" == "centos" ]]; then
            echo "Installing for Amazon Linux/RHEL/CentOS..."
            yum install -y amazon-ssm-agent
            systemctl start amazon-ssm-agent
            systemctl enable amazon-ssm-agent
            echo "SSM Agent status:"
            systemctl status amazon-ssm-agent
          else
            echo "Unsupported OS: $OS"
            exit 1
          fi
          
          # Verify installation
          echo ""
          echo "=== Installation Complete ==="
          systemctl status amazon-ssm-agent --no-pager
          SCRIPT_EOF
          
          chmod +x /tmp/install_ssm_agent.sh
          echo "‚úì Install script created"

      - name: Send SSM Agent Install Command
        if: steps.diagnose.outputs.diagnose_status == 'agent_missing' && github.event.inputs.install_ssm_agent == 'true'
        id: install-ssm
        run: |
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          echo "üì¶ Sending SSM Agent install command..."
          
          # Read script and encode it as JSON array
          SCRIPT_CONTENT=$(cat /tmp/install_ssm_agent.sh | jq -R -s -c 'split("\n")[:-1]')
          
          # Create JSON parameter
          PARAMS=$(jq -n --argjson commands "$SCRIPT_CONTENT" '{commands: $commands}')
          
          echo "Command parameters prepared (size: $(echo "$PARAMS" | wc -c) bytes)"
          
          COMMAND_RESPONSE=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE_ID" \
            --parameters "$PARAMS" \
            --comment "Install SSM Agent - $TIMESTAMP" \
            --output-s3-bucket-name "${{ env.S3_BUCKET }}" \
            --output-s3-key-prefix "${{ env.S3_PREFIX }}/ssm-install/$TIMESTAMP" \
            --region ${{ env.AWS_REGION }} \
            --output json)
          
          INSTALL_COMMAND_ID=$(echo "$COMMAND_RESPONSE" | jq -r ".Command.CommandId // empty")
          
          if [[ -z "$INSTALL_COMMAND_ID" ]]; then
            echo "‚ö†Ô∏è  Could not send install command via SSM"
            echo "Error response:"
            echo "$COMMAND_RESPONSE" | jq .
            echo ""
            echo "This means SSM agent is still not available."
            echo "Please manually SSH into the instance and run:"
            echo ""
            echo "For Amazon Linux 2:"
            echo "  sudo yum install -y amazon-ssm-agent"
            echo "  sudo systemctl start amazon-ssm-agent"
            echo ""
            echo "For Ubuntu:"
            echo "  sudo apt-get update"
            echo "  sudo apt-get install -y amazon-ssm-agent"
            echo "  sudo systemctl start amazon-ssm-agent"
            exit 1
          fi
          
          echo "‚úì Install command sent: $INSTALL_COMMAND_ID"
          echo "install_command_id=$INSTALL_COMMAND_ID" >> $GITHUB_OUTPUT
          echo "INSTALL_COMMAND_ID=$INSTALL_COMMAND_ID" >> $GITHUB_ENV

      - name: Wait for SSM Agent Installation
        if: steps.diagnose.outputs.diagnose_status == 'agent_missing' && github.event.inputs.install_ssm_agent == 'true'
        run: |
          INSTALL_COMMAND_ID=${{ env.INSTALL_COMMAND_ID }}
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          echo "‚è≥ Waiting for SSM Agent installation to complete..."
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$INSTALL_COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "Status" \
              --output text 2>&1)
            
            echo "[$((ATTEMPT+1))/$MAX_ATTEMPTS] Installation status: $STATUS"
            
            if [[ "$STATUS" == "Success" ]]; then
              echo "‚úì SSM Agent installed successfully!"
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
              echo "‚ùå Installation failed with status: $STATUS"
              echo ""
              echo "Error output:"
              aws ssm get-command-invocation \
                --command-id "$INSTALL_COMMAND_ID" \
                --instance-id "$INSTANCE_ID" \
                --region ${{ env.AWS_REGION }} \
                --output json | jq '.StandardErrorContent'
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 5
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå Installation timeout after $((MAX_ATTEMPTS*5)) seconds"
            exit 1
          fi

      - name: Wait for SSM Agent Registration
        id: ssm-ready
        run: |
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          echo "‚è≥ Waiting for SSM agent to register..."
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            PING_STATUS=$(aws ssm describe-instance-information \
              --instance-information-filter-list "key=InstanceIds,valueSet=$INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "InstanceInformationList[0].PingStatus" \
              --output text 2>&1)
            
            if [[ "$PING_STATUS" != "None" && -n "$PING_STATUS" ]]; then
              echo "[$((ATTEMPT+1))/$MAX_ATTEMPTS] Ping status: $PING_STATUS"
              
              if [[ "$PING_STATUS" == "Online" ]]; then
                echo "‚úì SSM agent is Online!"
                echo "ssm_ready=true" >> $GITHUB_OUTPUT
                break
              fi
            else
              echo "[$((ATTEMPT+1))/$MAX_ATTEMPTS] Waiting for agent registration..."
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 5
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ùå SSM agent did not register after $((MAX_ATTEMPTS*5)) seconds"
            echo ""
            echo "Troubleshooting:"
            echo "1. Verify instance IAM role has 'AmazonSSMManagedInstanceCore' policy"
            echo "2. Check instance has outbound internet or VPC endpoint access to SSM"
            echo "3. SSH into instance and check:"
            echo "   sudo systemctl status amazon-ssm-agent"
            echo "   sudo tail -f /var/log/amazon/ssm/amazon-ssm-agent.log"
            exit 1
          fi

      - name: Prepare Server Info Script
        id: prepare-script
        run: |
          if [ ! -f scripts/server_info.sh ]; then
            echo "‚ùå scripts/server_info.sh not found"
            exit 1
          fi
          
          # Convert script to JSON array format for SSM
          SCRIPT_JSON=$(cat scripts/server_info.sh | jq -R -s -c 'split("\n")[:-1]')
          
          echo "Script prepared ($(cat scripts/server_info.sh | wc -l) lines)"
          echo "script_json<<EOF" >> $GITHUB_OUTPUT
          echo "$SCRIPT_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Server Info Command
        id: send-command
        run: |
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          echo "üì§ Sending server_info.sh command..."
          
          # Use JSON-encoded script
          SCRIPT_JSON='${{ steps.prepare-script.outputs.script_json }}'
          PARAMS=$(jq -n --argjson commands "$(echo "$SCRIPT_JSON")" '{commands: $commands}')
          
          COMMAND_RESPONSE=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE_ID" \
            --parameters "$PARAMS" \
            --comment "Run server_info.sh - $TIMESTAMP" \
            --output-s3-bucket-name "${{ env.S3_BUCKET }}" \
            --output-s3-key-prefix "${{ env.S3_PREFIX }}/$TIMESTAMP" \
            --region ${{ env.AWS_REGION }} \
            --output json)
          
          COMMAND_ID=$(echo "$COMMAND_RESPONSE" | jq -r ".Command.CommandId // empty")
          
          if [[ -z "$COMMAND_ID" ]]; then
            echo "‚ùå Failed to send command"
            echo "$COMMAND_RESPONSE" | jq .
            exit 1
          fi
          
          echo "‚úì Command sent successfully!"
          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_ENV

      - name: Wait for Command Execution
        run: |
          COMMAND_ID=${{ env.COMMAND_ID }}
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          MAX_ATTEMPTS=120
          ATTEMPT=0
          
          echo "‚è≥ Waiting for command execution..."
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --region ${{ env.AWS_REGION }} \
              --query "Status" \
              --output text 2>&1)
            
            echo "[$((ATTEMPT+1))/$MAX_ATTEMPTS] Status: $STATUS"
            
            if [[ "$STATUS" == "Success" ]]; then
              echo "‚úì Command executed successfully!"
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              echo "‚ùå Command failed with status: $STATUS"
              exit 1
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            sleep 5
          done

      - name: Retrieve and Display Output
        if: success()
        run: |
          COMMAND_ID=${{ env.COMMAND_ID }}
          INSTANCE_ID=${{ env.INSTANCE_ID }}
          
          echo "üìã Command Output:"
          echo ""
          echo "=== STDOUT ==="
          
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'StandardOutputContent' \
            --output text
          
          echo ""
          echo "=== STDERR ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'StandardErrorContent' \
            --output text
          
          echo ""
          echo "‚úÖ Workflow Complete!"

      - name: Emergency Manual Steps
        if: failure() && steps.diagnose.outputs.diagnose_status == 'agent_missing'
        run: |
          cat << 'EOF'
          ========================================
          SSM AGENT INSTALLATION - MANUAL STEPS
          ========================================
          
          Since automatic installation failed, please do this manually:
          
          STEP 1: SSH into Instance
          --------------------------
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id i-01edf5a092db9d3e3 \
            --instance-os-user ec2-user \
            --ssh-public-key-body file://~/.ssh/id_rsa.pub \
            --region us-west-1
          
          Or use AWS Systems Manager Session Manager:
          aws ssm start-session --target i-01edf5a092db9d3e3 --region us-west-1
          
          
          STEP 2: Install SSM Agent (Choose your OS)
          -------------------------------------------
          
          For Amazon Linux 2:
            sudo yum update -y
            sudo yum install -y amazon-ssm-agent
            sudo systemctl start amazon-ssm-agent
            sudo systemctl enable amazon-ssm-agent
            sudo systemctl status amazon-ssm-agent
          
          For Ubuntu 20.04/22.04:
            sudo apt-get update
            sudo apt-get install -y amazon-ssm-agent
            sudo systemctl start amazon-ssm-agent
            sudo systemctl enable amazon-ssm-agent
            sudo systemctl status amazon-ssm-agent
          
          For RHEL/CentOS:
            sudo yum update -y
            sudo yum install -y amazon-ssm-agent
            sudo systemctl start amazon-ssm-agent
            sudo systemctl enable amazon-ssm-agent
            sudo systemctl status amazon-ssm-agent
          
          
          STEP 3: Verify Agent is Running
          ---------------------------------
          sudo systemctl status amazon-ssm-agent
          
          # Check logs
          sudo tail -100 /var/log/amazon/ssm/amazon-ssm-agent.log
          
          
          STEP 4: Verify in AWS Console
          ----------------------------
          aws ssm describe-instance-information \
            --region us-west-1 \
            --query "InstanceInformationList[?InstanceIds=='i-01edf5a092db9d3e3']"
          
          Should show PingStatus: "Online"
          
          
          STEP 5: Re-run Workflow
          ----------------------
          Once agent is Online, re-run this workflow.
          
          ========================================
          EOF
          exit 1
