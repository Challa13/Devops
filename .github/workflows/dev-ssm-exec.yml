name: Dev SSM - Server Info

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (must be dev)"
        required: true
        default: "dev"
      dry_run:
        description: "Dry run only (true/false)"
        required: true
        default: "false"

  schedule:
    - cron: "0 6 * * *"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-1

jobs:
  run-ssm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ðŸ›‘ DEV Guardrail
      - name: Validate Environment
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ github.event.inputs.environment }}" != "dev" ]]; then
            echo "This workflow is restricted to DEV only."
            exit 1
          fi

      # ðŸ” OIDC Authentication
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::034362042633:role/Github-role
          aws-region: ${{ env.AWS_REGION }}

      # ðŸ”Ž Verify DEV instances exist
      - name: Check DEV Instances
        id: check_instances
        run: |
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=dev" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text)

          if [ -z "$INSTANCES" ]; then
            echo "No DEV instances found."
            exit 1
          fi

          echo "instances=$INSTANCES" >> $GITHUB_OUTPUT
          echo "Found DEV instances: $INSTANCES"

      # ðŸ§ª Dry Run
      - name: Dry Run Mode
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "Dry run enabled."
          echo "Would target instances:"
          echo "${{ steps.check_instances.outputs.instances }}"
          exit 0

      # ðŸš€ Send server_info.sh to SSM
      - name: Send SSM Command
        id: send_command
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=dev" \
            --parameters commands="$(jq -R -s -c 'split("\n")[:-1]' scripts/server_info.sh)" \
            --comment "Run server_info.sh from GitHub Actions" \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Command ID: $COMMAND_ID"

      # â³ Wait for command status properly (no fragile instance waiter)
      - name: Wait for Command Completion
        run: |
          COMMAND_ID=${{ steps.send_command.outputs.command_id }}

          echo "Waiting for command to complete..."

          while true; do
            STATUS=$(aws ssm list-commands \
              --command-id $COMMAND_ID \
              --query "Commands[0].Status" \
              --output text)

            echo "Current status: $STATUS"

            if [[ "$STATUS" == "Success" ]]; then
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              echo "Command failed with status: $STATUS"
              exit 1
            fi

            sleep 5
          done

      # ðŸ“¥ Collect Output
      - name: Collect Outputs
        run: |
          mkdir -p logs
          COMMAND_ID=${{ steps.send_command.outputs.command_id }}

          aws ssm list-command-invocations \
            --command-id $COMMAND_ID \
            --details \
            --query "CommandInvocations[].InstanceId" \
            --output text | while read INSTANCE; do

              echo "Collecting logs for $INSTANCE"

              aws ssm get-command-invocation \
                --command-id $COMMAND_ID \
                --instance-id $INSTANCE \
                --query "StandardOutputContent" \
                --output text > logs/$INSTANCE.txt
            done

      # ðŸ“¦ Upload Logs
      - name: Upload Logs as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-ssm-server-info
          path: logs/
