name: Dev SSM Execution

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (must be dev)"
        required: true
        default: "dev"
      target_mode:
        description: "tag or instance"
        required: true
        default: "tag"
      tag_key:
        description: "Tag key (if tag mode)"
        required: false
        default: "Environment"
      tag_value:
        description: "Tag value (if tag mode)"
        required: false
        default: "dev"
      instance_ids:
        description: "Comma separated instance IDs (if instance mode)"
        required: false
      dry_run:
        description: "Dry run mode (true/false)"
        required: true
        default: "true"

  schedule:
    - cron: "0 6 * * *"   # Daily at 6 AM UTC

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  S3_LOG_BUCKET: my-dev-ssm-logs-bucket

jobs:
  ssm-run:
    runs-on: ubuntu-latest

    steps:

      - name: ðŸ›‘ DEV Guardrail Check
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ github.event.inputs.environment }}" != "dev" ]]; then
            echo "ERROR: This workflow is restricted to DEV only."
            exit 1
          fi

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/GitHubOIDC-Dev-SSM-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine Target Instances
        id: targets
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "Running scheduled job - defaulting to dev tag"
            TARGETS="Key=tag:Environment,Values=dev"
          else
            if [[ "${{ github.event.inputs.target_mode }}" == "tag" ]]; then
              TARGETS="Key=tag:${{ github.event.inputs.tag_key }},Values=${{ github.event.inputs.tag_value }}"
            else
              IDS=$(echo "${{ github.event.inputs.instance_ids }}" | tr ',' ' ')
              TARGETS="Key=instanceIds,Values=$IDS"
            fi
          fi

          echo "targets=$TARGETS" >> $GITHUB_OUTPUT

      - name: Dry Run Check
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "Dry run enabled. Would target:"
          echo "${{ steps.targets.outputs.targets }}"
          exit 0

      - name: Send SSM Command
        id: send_command
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "${{ steps.targets.outputs.targets }}" \
            --parameters commands=["hostname","uptime","df -h","free -m"] \
            --comment "GitHub Dev SSM Execution" \
            --query "Command.CommandId" \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Command ID: $COMMAND_ID"

      - name: Wait for Command Completion
        run: |
          aws ssm wait command-executed \
            --command-id ${{ steps.send_command.outputs.command_id }} \
            --instance-id $(aws ec2 describe-instances \
              --filters "Name=tag:Environment,Values=dev" \
              --query "Reservations[].Instances[].InstanceId" \
              --output text | awk '{print $1}')

      - name: Collect Output
        run: |
          mkdir -p logs
          for INSTANCE in $(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=dev" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text); do

            aws ssm get-command-invocation \
              --command-id ${{ steps.send_command.outputs.command_id }} \
              --instance-id $INSTANCE \
              --query "StandardOutputContent" \
              --output text > logs/$INSTANCE.txt
          done

      - name: Upload Logs to GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssm-dev-logs
          path: logs/

      - name: Upload Logs to S3
        run: |
          aws s3 cp logs/ s3://${{ env.S3_LOG_BUCKET }}/$(date +%F)/ --recursive
