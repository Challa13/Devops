name: Dev SSM - Server Info (S3 Output)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (must be dev)"
        required: true
        default: "dev"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-1
  ROLE_ARN: arn:aws:iam::034362042633:role/github-role11
  S3_BUCKET: dev-ssm-server-logs
  S3_PREFIX: server-info

jobs:
  run-ssm:
    runs-on: ubuntu-latest

    steps:

      # üì• Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # üõë DEV Guardrail
      - name: Validate Environment
        run: |
          if [[ "${{ github.event.inputs.environment }}" != "dev" ]]; then
            echo "This workflow is restricted to DEV only."
            exit 1
          fi

      # üîê Configure AWS Credentials (OIDC)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # üîé Validate DEV Instances Exist
      - name: Check DEV Instances
        run: |
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=dev" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text)

          if [ -z "$INSTANCES" ]; then
            echo "No DEV instances found."
            exit 1
          fi

          echo "Found DEV instances: $INSTANCES"

      - name: Print SSM Output (Single Instance)
        run: |
          INSTANCE=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=dev" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $INSTANCE \
            --query "StandardOutputContent" \
            --output text

      # üöÄ Execute Script via SSM (Output to S3)
      - name: Execute server_info.sh via SSM
        run: |
          if [ ! -f scripts/server_info.sh ]; then
            echo "scripts/server_info.sh not found!"
            exit 1
          fi

          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=dev" \
            --parameters commands="$(jq -R -s -c 'split("\n")[:-1]' scripts/server_info.sh)" \
            --comment "Run server_info.sh from GitHub Actions" \
            --output-s3-bucket-name $S3_BUCKET \
            --output-s3-key-prefix $S3_PREFIX \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          echo "Waiting for command completion..."

          # SAFE polling (not instance-based)
          while true; do
            STATUS=$(aws ssm list-commands \
              --command-id $COMMAND_ID \
              --query "Commands[0].Status" \
              --output text)

            echo "Current status: $STATUS"

            if [[ "$STATUS" == "Success" ]]; then
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              echo "Command failed with status: $STATUS"
              exit 1
            fi

            sleep 5
          done

          echo "Command execution completed successfully."

      # üì¶ Print S3 Output Location
      - name: Print S3 Output Location
        run: |
          echo "SSM output stored in:"
          echo "s3://$S3_BUCKET/$S3_PREFIX/"
      - name: List S3 Buckets
        run: |
          echo "Listing S3 Buckets..."
          aws s3 ls

      - name: Debug Identity
        run: |
          aws sts get-caller-identity
